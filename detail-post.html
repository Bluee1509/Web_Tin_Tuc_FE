<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết bài viết</title>
    <!-- start font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- end font -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- start icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- end icon -->
    <link rel="stylesheet" href="styles/reset.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/news.css">

</head>
<style>
    .comment-list {
        list-style: none;
        padding: 0;
    }

    .comment-item {
        margin-bottom: 20px;
        padding: 10px;
    }

    .comment-item .user {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .comment-item .content {
        margin-left: 20px;
    }

    .comment-list {
        list-style-type: none;
        padding-left: 0;
    }

    .comment-item {
        margin-bottom: 20px;
    }

    .reply-button {
        cursor: pointer;
    }

    .reply-list {
        list-style-type: none;
        padding-left: 0;
        padding-top: 10px;
        border-left: 1px solid gray;
        margin-left: 20px;
        padding-left: 20px;
    }

    .reply-item {
        margin-top: 10px;
    }

    .comment-item-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .content-comment{
        padding-left: 25px;
    }
</style>

<body>
    <header id="myHeader">
        <div class="container">
            <div class="header__logo">
                <a href="./">
                    <span>SKYNET</span>
                </a>
            </div>
            <div id="burger-menu">
                <span></span>
            </div>

            <div id="menu">
                <ul>
                    <li><a href="./">Trang chủ</a></li>
                    <li><a href="./price.html">Bảng giá</a></li>
                    <li><a href="./about.html">Về chúng tôi</a></li>
                    <li><a href="./news.html">Tin tức</a></li>
                </ul>
            </div>
            <div class="header__nav">
                <ul>
                    <li>
                        <a href="./">Trang chủ</a>
                    </li>
                    <li>
                        <a href="./price.html">Bảng giá</a>
                    </li>
                    <li>
                        <a href="./about.html">Về chúng tôi</a>
                    </li>
                    <li>
                        <a href="./news.html">Tin tức</a>
                    </li>
                </ul>
            </div>
        </div>
    </header>
    <section class="news">
        <div class="new__bg"></div>

        </div>
    </section>
    <section class="detail-post">
        <div class="container">
            <h2 class="detail-post__title"></h2>
            <p class="detail-post__timeline"></p>
            <div class="detail-post__content"></div>
        </div>
    </section>
    <section class="comments mt-5">
        <div class="container">
            <form id="commentForm" class="mt-5">
                <!-- Thêm ô nhập username -->
                <div class="form-group">
                    <label for="username">Tên đăng nhập:</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <!-- Ô nhập bình luận -->
                <div class="form-group  mt-3">
                    <label for="comment">Bình luận của bạn:</label>
                    <textarea class="form-control" id="comment" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Gửi</button>
            </form>
            <h3 class="mb-3 mt-5">Bình luận</h3>
            <ul class="comment-list">
                <!-- Danh sách bình luận sẽ được hiển thị ở đây -->
            </ul>
        </div>
    </section>

    <footer class="footer-primary">
        <div class="container">
            <div class="row">
                <div class="col-lg-6">
                    <div class="footer__item">
                        <div class="header__logo__footer">
                            <span>tech.</span>
                        </div>
                        <p class="footer__sub">Mua Hosting giá rẻ khởi chạy ngay dự án của bạn với mức chi phí thấp nhất
                            nhưng tích hợp công
                            nghệ hiện đại nhất, NVMe
                            Web Hosting tại TinoHost tự tin khởi chạy mọi dự án website của bạn.</p>
                    </div>
                </div>
                <div class="col-12 col-lg-2">
                    <div class="footer__item">
                        <h3>Về tech.</h3>
                        <ul>
                            <li><span>Sứ mệnh</span></li>
                            <li><span>Giá trị cốt lỏi</span></li>
                            <li><span>Cột mốc chính</span></li>
                        </ul>
                    </div>
                </div>
                <div class="col-12 col-lg-2">
                    <div class="footer__item">
                        <h3>Tin tức</h3>
                        <ul>
                            <li><span>Tin tức mới nhất</span></li>
                            <li><span>Tin tức nổi bật</span></li>
                        </ul>
                    </div>
                </div>
                <div class="col-12 col-lg-2">
                    <div class="footer__item">
                        <h3>Liên hệ</h3>
                        <ul>
                            <li><span>Phone : 099******</span></li>
                            <li><span>Mail : tech@gmail.com</span></li>
                            <li><span>Văn phòng : 3/2, P. Xuân Khánh, Q. Ninh Kiều, TP. CT</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="line"></div>
            <p>© 2024 tech. All Rights Reserved</p>
        </div>
    </footer>
</body>
<script src="js/scroll_header.js"></script>
<script src="js/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');

    async function fetchPostDetails() {
        const response = await fetch(`http://localhost:8080/api/post/${postId}`);
        const data = await response.json();
        return data;
    }

    async function displayPostDetails() {
        const post = await fetchPostDetails();

        console.log(post)

        const titleElement = document.querySelector('.detail-post__title');
        titleElement.textContent = post.title;


        const timelineElement = document.querySelector('.detail-post__timeline');
        timelineElement.textContent = post.timeline;

        const contentElement = document.querySelector('.detail-post__content');
        contentElement.innerHTML = post.content;
    }
    async function fetchComments() {
        const response = await fetch(`http://localhost:8080/api/comment/${postId}`);
        const data = await response.json();
        return data;
    }

    displayPostDetails();
</script>
<script>
    document.getElementById("commentForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const postId = getUrlParam('id');
        const nameuser = document.getElementById('username').value;
        const content = document.getElementById('comment').value;

        const commentData = {
            "idPost": postId,
            "nameuser": nameuser,
            "content": content
        };

        fetch("http://localhost:8080/api/comment", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(commentData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to add comment.");
                }
                console.log(response);
                Swal.fire({
                    icon: 'success',
                    title: 'Bình luận đã được gửi thành công!',
                    showConfirmButton: false,
                    timer: 1500
                });
                document.getElementById("commentForm").reset();
                displayComments();
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Có lỗi xảy ra khi gửi bình luận.");
            });
    });


    function getUrlParam(paramName) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(paramName);
    }
</script>
<script>

    function createReplyInput(commentId) {
        const usernameInput = document.createElement('input');
        usernameInput.setAttribute('type', 'text');
        usernameInput.setAttribute('placeholder', 'Tên');
        usernameInput.setAttribute('id', 'replyUsername');
        usernameInput.classList.add('form-control', 'reply-username', 'mb-2', 'mt-3');

        const replyInput = document.createElement('input');
        replyInput.setAttribute('type', 'text');
        replyInput.setAttribute('placeholder', 'Nhập reply của bạn');
        replyInput.setAttribute('id', 'replyContent');
        replyInput.setAttribute('idCmtParent', commentId);
        replyInput.classList.add('form-control', 'reply-input', 'mb-3');


        const replyForm = document.createElement('form');
        replyForm.classList.add('reply-form');
        replyForm.appendChild(usernameInput);
        replyForm.appendChild(replyInput);

        const sendButton = document.createElement('button');
        sendButton.setAttribute('type', 'button');
        sendButton.textContent = 'Gửi';
        sendButton.classList.add('btn', 'btn-primary', 'reply-send-button');

        sendButton.addEventListener('click', function () {
            const username = document.getElementById('replyUsername').value;
            const replyContent = document.getElementById('replyContent').value;

            sendReply(username, commentId, replyContent);

            replyForm.remove();
        });

        replyForm.appendChild(sendButton);

        return replyForm;
    }


    function sendReply(username, parentCommentId, replyContent) {
        const postId = getUrlParam('id');

        const replyData = {
            "idPost": postId,
            "nameuser": username,
            "content": replyContent,
            "idCmtParent": parentCommentId
        };

        fetch("http://localhost:8080/api/comment", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(replyData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to add reply.");
                }
                console.log(response);
                Swal.fire({
                    icon: 'success',
                    title: 'Reply đã được gửi thành công!',
                    showConfirmButton: false,
                    timer: 1500
                });

                displayComments();
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Có lỗi xảy ra khi gửi reply.");
            });
    }

    async function fetchReplies(commentId) {
        try {
            const response = await fetch(`http://localhost:8080/api/comment/reply/${commentId}`);

            if (!response.ok) {
                throw new Error('Không thể tải dữ liệu.');
            }

            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Lỗi khi tải dữ liệu:', error.message);
            return null;
        }
    }


    async function displayComments() {
        const comments = await fetchComments();
        const commentList = document.querySelector('.comment-list');

        commentList.innerHTML = '';
        const filteredComments = comments.filter(comment => comment.idCmtParent == null).reverse();


        for (const comment of filteredComments) {
            const li = document.createElement('li');
            li.classList.add('comment-item');

            const div = document.createElement('div');
            div.classList.add('comment-item-wrap');

            const anonymousAvatar = document.createElement('img');
            anonymousAvatar.src = '/assets/avatar.jpg';
            anonymousAvatar.classList.add('rounded-circle', 'shadow-1-strong');
            anonymousAvatar.width = 35;
            anonymousAvatar.height = 35;
            div.appendChild(anonymousAvatar);

            const userSpan = document.createElement('span');
            userSpan.classList.add('user');
            userSpan.textContent = comment.nameuser;
            div.appendChild(userSpan);

            const contentSpan = document.createElement('span');
            contentSpan.classList.add('content', 'content-comment');
            contentSpan.textContent = comment.content;

            const replyButton = document.createElement('a');
            replyButton.innerHTML = '<i class="fa-solid fa-reply"></i>';
            replyButton.classList.add('reply-button');
            div.appendChild(replyButton);

            replyButton.addEventListener('click', function () {
                const existingReplyForm = li.querySelector('.reply-form');
                if (!existingReplyForm) {
                    const replyForm = createReplyInput(comment.idCmt);
                    li.appendChild(replyForm);
                } else {
                    existingReplyForm.remove();
                }
            });

            const replies = await fetchReplies(comment.idCmt);

            if (!replies || replies.length === 0) {
                li.appendChild(div);
                li.appendChild(contentSpan);
                commentList.appendChild(li);
                continue;
            }

            const replyList = document.createElement('ul');
            replyList.classList.add('reply-list');

            replies.forEach(reply => {
                const divReply = document.createElement('div');
                divReply.classList.add('comment-item-wrap');

                const anonymousAvatarReply = document.createElement('img');
                anonymousAvatarReply.src = '/assets/avatar.jpg';
                anonymousAvatarReply.classList.add('rounded-circle', 'shadow-1-strong');
                anonymousAvatarReply.width = 35;
                anonymousAvatarReply.height = 35;
                divReply.appendChild(anonymousAvatarReply);

                const replyItem = document.createElement('li');
                replyItem.classList.add('reply-item');

                const replyUserSpan = document.createElement('span');
                replyUserSpan.classList.add('user');
                replyUserSpan.textContent = reply.nameuser;
                divReply.appendChild(replyUserSpan)

                const replyContentSpan = document.createElement('span');
                replyContentSpan.classList.add('content', 'content-comment');
                replyContentSpan.textContent = reply.content;

                replyItem.appendChild(divReply);
                replyItem.appendChild(replyContentSpan);
                replyList.appendChild(replyItem);
            });

            li.appendChild(div);
            li.appendChild(contentSpan);
            li.appendChild(replyList);

            commentList.appendChild(li);
        }
    }

    displayComments();
</script>

</html>